<div class="forum-page">
  <!-- HEADER -->
  <header class="forum-header">
    <div class="forum-header__text">
      <span class="pill pill-soft">
        <i class="fas fa-comments"></i>
        Foro
      </span>

      <h1>Foro de historias</h1>

      <p class="forum-subtitle">
        Publica tus historias terminadas o en progreso para que otros usuarios puedan leer y comentar.
      </p>
    </div>

    <button class="btn-primary" (click)="openModal()">
      <i class="fas fa-plus"></i>
      <span>Publicar historia</span>
    </button>
  </header>

  <!-- CUERPO -->
  <div class="forum-body">
    <!-- Columna izquierda: listado -->
    <section class="forum-main">
      <!-- Loader general -->
      <div class="forum-loader-wrapper" *ngIf="loading() || forumService.loading$()">
        <app-loader></app-loader>
      </div>

      <!--  Barra de filtros -->
      <div class="forum-filters" *ngIf="!loading()">
        <div class="filter-group">
          <label for="filterGenre">G茅nero</label>
          <select id="filterGenre" [(ngModel)]="filterGenre">
            <option value="">Todos</option>
            <option *ngFor="let g of genreNames" [value]="g">
              {{ g }}
            </option>
          </select>
        </div>

        <div class="filter-group">
          <label for="filterAuthor">Autor</label>
          <input
            id="filterAuthor"
            type="text"
            [(ngModel)]="filterAuthor"
            placeholder="Buscar por nombre de autor..."
          />
        </div>
      </div>

      <!-- Lista de publicaciones -->
      <section class="forum-content" *ngIf="!loading()">
        <app-forum-list
          [forumPosts]="filteredPosts"
          [currentUserName]="currentUserName"
          (callEditMethod)="updatePost($event)"
          (callDeleteMethod)="deletePost($event)"
          (callOpenDetails)="openPostDetails($event)">
        </app-forum-list>
      </section>
    </section>
  </div>

  <!-- MODAL: crear / editar publicaci贸n -->
  <ng-template #addForumPostModal>
    <app-modal [hideFooter]="true" [useCustomBackGround]="true">
      <app-forum-post-form
        [forumForm]="forumPostForm"
        [genres]="genreNames"
        [availableStories]="stories"
        (save)="savePost()"
        (cancel)="closeModal()">
      </app-forum-post-form>
    </app-modal>
  </ng-template>

  <!-- MODAL: detalle de historia -->
  <ng-template #postDetailsModal>
    <app-modal [hideFooter]="true" [useCustomBackGround]="true">
      <div class="modal-form-container story-detail-modal" *ngIf="selectedPost">
        <header class="modal-header-custom">
          <div class="title-block">
            <span class="pill small">
              <i class="fas fa-book-open"></i>
              Detalle de historia
            </span>
            <h2>{{ selectedPost.storyTitle || 'Historia sin t铆tulo' }}</h2>
            <p class="subtitle">
              Vista de lectura de la historia publicada en el foro.
            </p>
          </div>

          <button type="button" class="btn-close-modal" (click)="closeDetails()">
            <i class="fas fa-times"></i>
          </button>
        </header>

        <!-- Meta -->
        <div class="story-detail-meta">
          <span>
            <i class="fas fa-user"></i>
            {{ selectedPost.authorName || 'Autor desconocido' }}
          </span>

          <span *ngIf="selectedPost.publishedAt">
            <i class="fas fa-clock"></i>
            {{ selectedPost.publishedAt | date: 'short' }}
          </span>

          <span *ngIf="selectedPost.genre">
            <i class="fas fa-tag"></i>
            {{ selectedPost.genre }}
          </span>

          <span>
            <i class="fas fa-eye"></i>
            {{ selectedPost.views || 0 }} vistas
          </span>

          <span>
            <i class="fas fa-comments"></i>
            {{ selectedPost.comments || 0 }} comentarios
          </span>

          <span class="visibility-tag" [class.visibility-tag--private]="!selectedPost.isPublic">
            {{ selectedPost.isPublic ? 'P煤blica' : 'Privada' }}
          </span>
        </div>

        <!-- Sinopsis -->
        <p class="story-detail-synopsis">
          {{ selectedPost.synopsis }}
        </p>

        <!-- Contenido -->
        <div class="story-detail-content" *ngIf="selectedPost.content">
          <h3>Contenido de la historia</h3>
          <div class="story-html" [innerHTML]="selectedPost.content"></div>
        </div>
      </div>
    </app-modal>
  </ng-template>

  <!-- MODAL: confirmar borrado de publicaci贸n -->
  <ng-template #deleteForumPostModal>
    <app-modal [hideFooter]="true" [useCustomBackGround]="true">
      <div class="modal-form-container delete-modal">
        <div class="modal-header-custom">
          <h2>Eliminar publicaci贸n</h2>
        </div>

        <p class="confirmation-message">
          驴Est谩s seguro de que deseas eliminar esta publicaci贸n del foro?
          Esta acci贸n no se puede deshacer.
        </p>

        <div class="form-actions">
          <button type="button" class="btn-cancel" (click)="closeModal()">
            Cancelar
          </button>
          <button type="button" class="btn-submit" (click)="confirmDelete()">
            <span>Eliminar</span>
          </button>
        </div>
      </div>
    </app-modal>
  </ng-template>
</div>
