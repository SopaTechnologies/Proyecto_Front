<!-- Contenedor con scroll para personajes -->
<div class="personajes-scroll-container">
  <div class="personajes-container">
    <div class="personajes-content">
      <!-- Ãrbol genealÃ³gico -->
      <div class="genealogia-container" *ngIf="personajes.length > 0">
        <ng-container *ngFor="let personaje of getPersonajesRaiz(); let last = last">
          <!-- Nodo raÃ­z -->
          <div class="arbol-personaje">
            <ng-container
              *ngTemplateOutlet="arbolNodo; context: { $implicit: personaje }"
            ></ng-container>
          </div>

          <!-- Separador entre familias -->
          <div class="familia-separador" *ngIf="!last">
            <br />
            <br />
            <hr />
          </div>
        </ng-container>
      </div>

      <!-- Estado vacÃ­o para personajes -->
      <div *ngIf="personajes.length === 0" class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-user-plus"></i>
        </div>
        <h3>No tienes personajes creados</h3>
        <p>Comienza a dar vida a tu historia creando personajes Ãºnicos con IA</p>
        <button class="create-first-btn" (click)="onCreatePersonaje()">
          <i class="fas fa-magic"></i>
          Crear primer personaje
        </button>
      </div>

    </div>
  </div>
</div>

<!-- ===================================================== -->
<!-- TEMPLATE RECURSIVO: UN NODO DEL ÃRBOL (PERS)          -->
<!-- ===================================================== -->
<ng-template #arbolNodo let-pers>
  <div class="container-fluid">
    <div class="row justify-content-center g-3">
      <!-- Si tiene pareja -->
      <ng-container
        *ngIf="
          pers.relacionId &&
          tieneRelacion(pers.relacionId) &&
          getPareja(pers.id!, pers.relacionId) as pareja;
        else soloPers
      ">
        <!-- Personaje principal -->
        <div class="col-12 col-md-6">
          <div class="personaje-card">
            <div class="personaje-image-container">
              <img
                [src]="pers.imagenUrl || placeholderImageUrl"
                [alt]="pers.nombre"
                class="personaje-image"
                (error)="onImageError($event)"
              />
            </div>
            <div class="personaje-info">
              <h3 class="personaje-nombre">
                {{ pers.nombre }} {{ pers.apellido }}
              </h3>
              <p class="personaje-descripcion">
                {{ pers.descripcion }}
              </p>
              <div class="personaje-meta">
                <span class="personaje-fecha">
                  <i class="fas fa-calendar"></i>
                  {{ pers.createdAt | date : 'dd/MM/yyyy' }}
                </span>
                <span class="personaje-status">
                  <i class="fas fa-circle"></i>
                  {{ pers.estado }}
                </span>
              </div>
            </div>
            <div class="personaje-actions">
              <button
                class="btn-edit"
                (click)="onEditPersonaje(pers)"
                title="Editar"
              >
                <i class="fas fa-edit"></i>
              </button>
              <button
                class="btn-delete"
                (click)="onDeletePersonaje(pers.id!)"
                title="Eliminar"
              >
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Pareja -->
        <div class="col-12 col-md-6">
          <div class="personaje-card">
            <div class="personaje-image-container">
              <img
                [src]="pareja.imagenUrl || placeholderImageUrl"
                [alt]="pareja.nombre"
                class="personaje-image"
                (error)="onImageError($event)"
              />
            </div>
            <div class="personaje-info">
              <h3 class="personaje-nombre">
                {{ pareja.nombre }} {{ pareja.apellido }}
              </h3>
              <p class="personaje-descripcion">
                {{ pareja.descripcion }}
              </p>
              <div class="personaje-meta">
                <span class="personaje-fecha">
                  <i class="fas fa-calendar"></i>
                  {{ pareja.createdAt | date : 'dd/MM/yyyy' }}
                </span>
                <span class="personaje-status">
                  <i class="fas fa-circle"></i>
                  {{ pareja.estado }}
                </span>
              </div>
            </div>
            <div class="personaje-actions">
              <button
                class="btn-edit"
                (click)="onEditPersonaje(pareja)"
                title="Editar"
              >
                <i class="fas fa-edit"></i>
              </button>
              <button
                class="btn-delete"
                (click)="onDeletePersonaje(pareja.id!)"
                title="Eliminar"
              >
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </ng-container>

      <!-- Sin pareja -->
      <ng-template #soloPers>
        <div class="col-12 col-md-6">
          <div class="personaje-card">
            <div class="personaje-image-container">
              <img
                [src]="pers.imagenUrl || placeholderImageUrl"
                [alt]="pers.nombre"
                class="personaje-image"
                (error)="onImageError($event)"
              />
            </div>
            <div class="personaje-info">
              <h3 class="personaje-nombre">
                {{ pers.nombre }} {{ pers.apellido }}
              </h3>
              <p class="personaje-descripcion">
                {{ pers.descripcion }}
              </p>
              <div class="personaje-meta">
                <span class="personaje-fecha">
                  <i class="fas fa-calendar"></i>
                  {{ pers.createdAt | date : 'dd/MM/yyyy' }}
                </span>
                <span class="personaje-status">
                  <i class="fas fa-circle"></i>
                  {{ pers.estado }}
                </span>
              </div>
            </div>
            <div class="personaje-actions">
              <button
                class="btn-edit"
                (click)="onEditPersonaje(pers)"
                title="Editar"
              >
                <i class="fas fa-edit"></i>
              </button>
              <button
                class="btn-delete"
                (click)="onDeletePersonaje(pers.id!)"
                title="Eliminar"
              >
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </ng-template>
    </div>
  </div>

  <!-- Hijos de este personaje (subnivel del Ã¡rbol) -->
  <div class="genealogia-hijos-wrapper" *ngIf="tieneHijos(pers.id!)">
    <div class="genealogia-hijos-list">
      <ng-container *ngFor="let hijo of getHijos(pers.id!)">
        <div class="arbol-personaje">
          <ng-container
            *ngTemplateOutlet="arbolNodo; context: { $implicit: hijo }"
          ></ng-container>
        </div>
      </ng-container>
    </div>
  </div>

  <!-- Enemigos -->
  <div class="enemigos-wrapper" *ngIf="tieneEnemigos(pers.id!)">
    <div class="enemigos-header">
      <span class="enemigos-icon">âš”ï¸</span>
      <span class="enemigos-title">Enemigos</span>
    </div>
    <div class="enemigos-list">
      <div
        class="enemigo-card"
        *ngFor="let enemigo of getEnemigos(pers.id!)"
      >
        <div class="personaje-image-container">
          <img
            [src]="enemigo.imagenUrl || placeholderImageUrl"
            [alt]="enemigo.nombre"
            class="personaje-image"
            (error)="onImageError($event)"
          />
        </div>
        <div class="personaje-info">
          <h3 class="personaje-nombre">
            {{ enemigo.nombre }} {{ enemigo.apellido }}
          </h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Amistades -->
  <div class="amistades-wrapper" *ngIf="tieneAmistades(pers.id!)">
    <div class="amistades-header">
      <span class="amistades-icon">ğŸ¤</span>
      <span class="amistades-title">Amistades</span>
    </div>
    <div class="amistades-list">
      <div
        class="amistad-card"
        *ngFor="let amistad of getAmistades(pers.id!)"
      >
        <div class="personaje-image-container">
          <img
            [src]="amistad.imagenUrl || placeholderImageUrl"
            [alt]="amistad.nombre"
            class="personaje-image"
            (error)="onImageError($event)"
          />
        </div>
        <div class="personaje-info">
          <h3 class="personaje-nombre">
            {{ amistad.nombre }} {{ amistad.apellido }}
          </h3>
        </div>
      </div>
    </div>
  </div>
</ng-template>
